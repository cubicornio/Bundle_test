{% extends "base.html" %}

{% block title %}Cubicornio · Bundle Flask{% endblock %}

{% block content %}

<div class="flex gap-4">
  {# Sidebar (desktop + topbar mobile dentro del partial) #}
  {% include "_partials/sidebar.html" %}

  {# Main content #}
  <main class="flex-1 min-w-0">

    <div
      class="relative w-full rounded-3xl border border-emerald-400/60
             bg-gradient-to-b from-slate-950 via-slate-950 to-zinc-950
             text-zinc-50 p-6 md:p-8
             shadow-[0_0_40px_rgba(16,185,129,0.35)]
             overflow-hidden"
    >
      <!-- Glows -->
      <div class="pointer-events-none absolute -top-32 -right-16 w-64 h-64 bg-emerald-500/15 blur-3xl rounded-full"></div>
      <div class="pointer-events-none absolute -bottom-40 -left-24 w-72 h-72 bg-cyan-500/20 blur-3xl rounded-full"></div>
      <div class="pointer-events-none absolute inset-0 border border-emerald-400/15 rounded-[1.6rem]"></div>

      <div class="relative space-y-6">
        {# Error OAuth, si llega ?oauth_error=... #}
        {% if oauth_error %}
          <div class="rounded-2xl border border-red-500/60 bg-red-500/10 px-4 py-2 text-xs md:text-sm text-red-100">
            <span class="font-semibold">Error al conectar con Cubicornio:</span>
            <code class="font-mono text-[11px]">{{ oauth_error }}</code>
          </div>
        {% endif %}

        <!-- Header + botón Ir a Cubicornio -->
        <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-start gap-3">
            <div class="inline-flex items-center justify-center h-10 w-10 rounded-2xl bg-emerald-500/15 border border-emerald-400/60">
              <i data-lucide="puzzle" class="w-5 h-5 text-emerald-300"></i>
            </div>
            <div>
              <h1 class="text-2xl md:text-3xl font-bold leading-tight flex items-center gap-2">
                <span>Cubicornio · Bundle Flask</span>
              </h1>
              <p class="mt-2 text-sm md:text-base text-zinc-200 max-w-xl">
                Este bundle está conectado a <span class="font-semibold">Cubicornio</span> mediante OAuth 2.0.
                Úsalo como base para tus submódulos.
              </p>
            </div>
          </div>

          <a
            href="{{ cubicornio_url or 'https://cubicornio.com' }}"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 rounded-full border border-emerald-400/70
                   bg-emerald-500 px-4 py-2 text-xs sm:text-sm font-semibold text-slate-950
                   shadow-lg shadow-emerald-500/40 hover:bg-emerald-400 hover:border-emerald-400
                   transition"
          >
            <i data-lucide="square-arrow-out-up-right" class="w-4 h-4"></i>
            <span>Ir a Cubicornio</span>
          </a>
        </header>

        <!-- Estado de conexión -->
        <div>
          {% if token %}
            <div class="inline-flex items-center gap-2 rounded-full bg-emerald-500/10 border border-emerald-500/50 px-3 py-1.5 text-xs font-medium text-emerald-200">
              <i data-lucide="check-circle-2" class="w-4 h-4"></i>
              <span>Conectado a Cubicornio</span>
            </div>
          {% else %}
            <div class="inline-flex items-center gap-2 rounded-full bg-red-500/10 border border-red-500/50 px-3 py-1.5 text-xs font-medium text-red-100">
              <i data-lucide="x-circle" class="w-4 h-4"></i>
              <span>No hay conexión activa con Cubicornio</span>
            </div>
          {% endif %}
        </div>

        <!-- Grid: Usuario + Empresa (solo si hay token) -->
        {% if token %}
        <section class="grid gap-4 md:grid-cols-2">
          <!-- Usuario -->
          <div class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="h-8 w-8 rounded-lg bg-slate-900 flex items-center justify-center">
                <i data-lucide="user-round" class="w-4 h-4 text-slate-100"></i>
              </div>
              <div>
                <div class="text-[11px] uppercase tracking-wide text-slate-400 font-semibold">
                  Usuario conectado
                </div>
              </div>
            </div>

            {% if cubi_user %}
              <dl class="space-y-1.5 text-xs">
                {% if cubi_user.username %}
                <div class="flex items-center gap-2">
                  <span class="w-16 text-slate-400 shrink-0">Usuario</span>
                  <span class="text-slate-50 font-medium truncate">{{ cubi_user.username }}</span>
                </div>
                {% endif %}

                {% if cubi_user.email %}
                <div class="flex items-center gap-2">
                  <span class="w-16 text-slate-400 shrink-0">Email</span>
                  <span class="text-slate-100 truncate">{{ cubi_user.email }}</span>
                </div>
                {% endif %}

                {% if cubi_user.id %}
                <div class="flex items-center gap-2">
                  <span class="w-16 text-slate-400 shrink-0">ID Login</span>
                  <span class="font-mono text-[11px] text-slate-200">
                    {{ cubi_user.id }}
                  </span>
                </div>
                {% endif %}
              </dl>
            {% else %}
              <p class="text-xs text-slate-400">
                El bundle está conectado, pero no se recibieron datos de usuario (revisa la llamada a la API de Cubicornio).
              </p>
            {% endif %}
          </div>

          <!-- Empresa -->
          <div class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4">
            <div class="flex items-center gap-2 mb-3">
              <div class="h-8 w-8 rounded-lg bg-slate-900 flex items-center justify-center">
                <i data-lucide="building-2" class="w-4 h-4 text-slate-100"></i>
              </div>
              <div>
                <div class="text-[11px] uppercase tracking-wide text-slate-400 font-semibold">
                  Empresa vinculada
                </div>
              </div>
            </div>

            {% if cubi_business %}
              <dl class="space-y-1.5 text-xs">
                {% if cubi_business.display_name %}
                <div class="flex items-center gap-2">
                  <span class="w-20 text-slate-400 shrink-0">Nombre</span>
                  <span class="text-slate-50 font-medium truncate">
                    {{ cubi_business.display_name }}
                  </span>
                </div>
                {% endif %}

                {% if cubi_business.legal_name and cubi_business.legal_name != cubi_business.display_name %}
                <div class="flex items-center gap-2">
                  <span class="w-20 text-slate-400 shrink-0">Razón social</span>
                  <span class="text-slate-100 truncate">
                    {{ cubi_business.legal_name }}
                  </span>
                </div>
                {% endif %}

                {% if cubi_business.id or cubi_business.idbusiness %}
                <div class="flex items-center gap-2">
                  <span class="w-20 text-slate-400 shrink-0">ID negocio</span>
                  <span class="font-mono text-[11px] text-slate-200">
                    {{ cubi_business.id or cubi_business.idbusiness }}
                  </span>
                </div>
                {% endif %}

                <div class="flex items-center gap-2">
                  <span class="w-20 text-slate-400 shrink-0">Rol</span>
                  {% if is_owner %}
                    <span class="inline-flex items-center gap-1 rounded-full bg-emerald-500/15 border border-emerald-500/50 px-2 py-0.5 text-[11px] font-medium text-emerald-200">
                      <i data-lucide="shield-check" class="w-3.5 h-3.5"></i>
                      Owner
                    </span>
                  {% else %}
                    <span class="inline-flex items-center gap-1 rounded-full bg-sky-500/15 border border-sky-500/40 px-2 py-0.5 text-[11px] font-medium text-sky-200">
                      <i data-lucide="user-round-cog" class="w-3.5 h-3.5"></i>
                      Colaborador
                    </span>
                  {% endif %}
                </div>
              </dl>
            {% else %}
              <p class="text-xs text-slate-400">
                No se recibieron datos de empresa vinculada (puedes exponer un endpoint tipo <code class="font-mono text-[11px]">/dev/oauth/me</code> en Cubicornio).
              </p>
            {% endif %}
          </div>
        </section>

        <!-- Scopes -->
        <section class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 space-y-2 text-sm">
          <div class="flex items-center gap-2 mb-1">
            <div class="h-7 w-7 rounded-lg bg-slate-900 flex items-center justify-center">
              <i data-lucide="key-round" class="w-4 h-4 text-slate-100"></i>
            </div>
            <div class="text-[11px] uppercase tracking-wide text-slate-400 font-semibold">
              Permisos otorgados al bundle (scopes)
            </div>
          </div>

          {% if scopes %}
            <div class="flex flex-wrap gap-1.5 text-[11px]">
              {% for s in scopes %}
              <span class="inline-flex items-center gap-1 rounded-full bg-slate-900 px-2 py-0.5 border border-slate-700 text-slate-100">
                <i data-lucide="check" class="w-3 h-3"></i>
                <code>{{ s }}</code>
              </span>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-xs text-slate-400">
              No se recibieron scopes explícitos (por defecto podrías estar usando <code class="font-mono text-[11px]">bundle:read</code>).
            </p>
          {% endif %}
        </section>
        {% endif %}

        <!-- Paso 1: Config credenciales -->
        <section class="rounded-2xl border border-slate-800 bg-slate-950/90 p-4 space-y-3 text-sm">
          <h2 class="text-xs font-semibold uppercase tracking-wide text-slate-400">
            Paso 1 · Configura tu OAuth App en Cubicornio
          </h2>
          <ol class="list-decimal pl-5 space-y-1 text-zinc-200 text-xs md:text-sm">
            <li>Entra al <strong>Dev Portal</strong> de Cubicornio y ve a <code class="font-mono text-[11px] bg-slate-950 px-1.5 py-0.5 rounded border border-slate-800">OAuth Apps / Tokens</code>.</li>
            <li>Crea una nueva OAuth App con el Redirect URI:
              <code class="font-mono text-[11px] bg-slate-950 px-1.5 py-0.5 rounded border border-slate-800">
                http://127.0.0.1:5000/auth/cubicornio/callback
              </code>
            </li>
            <li>Copia tu <code class="font-mono text-[11px] bg-slate-950 px-1.5 py-0.5 rounded border border-slate-800">client_id</code> y
              <code class="font-mono text-[11px] bg-slate-950 px-1.5 py-0.5 rounded border border-slate-800">client_secret</code> en el <code>.env</code> de este bundle.
            </li>
          </ol>

          <pre class="bg-slate-950/90 border border-slate-800 rounded-xl px-3 py-2 text-[11px] text-emerald-200 whitespace-pre-wrap overflow-x-auto">
FLASK_SECRET_KEY=pon_aqui_una_clave_segura
CUBICORNIO_CLIENT_ID=tu_client_id
CUBICORNIO_CLIENT_SECRET=tu_client_secret
          </pre>
        </section>

        <!-- Paso 2: Login / Logout -->
        <section class="rounded-2xl border border-slate-800 bg-slate-950/90 p-4 space-y-3 text-sm">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div>
              <h2 class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                Paso 2 · Inicia sesión con Cubicornio
              </h2>
              <p class="mt-1 text-xs md:text-sm text-zinc-300">
                Te redirigiremos a Cubicornio para autenticarte y autorizar este bundle.
                Luego regresarás aquí con tu token.
              </p>
            </div>

            <div class="flex items-center gap-2">
              {% if not token %}
                <a
                  href="{{ url_for('cubicornio_auth.login', next=request.path) }}"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 text-xs md:text-sm font-semibold hover:bg-emerald-400 shadow-[0_0_20px_rgba(16,185,129,0.55)]"
                >
                  <i data-lucide="log-in" class="w-4 h-4"></i>
                  <span>Iniciar sesión con Cubicornio</span>
                </a>
              {% else %}
                <form action="{{ url_for('cubicornio_auth.logout') }}" method="get">
                  <button
                    type="submit"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-900 border border-slate-700 text-xs md:text-sm text-slate-100 hover:bg-slate-800"
                  >
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Cerrar sesión local</span>
                  </button>
                </form>
              {% endif %}
            </div>
          </div>

          {# ✅ NO MOSTRAR TOKENS. NUNCA. #}
          <p class="text-[11px] text-zinc-500">
            Nota: por seguridad, este bundle no muestra tokens en la interfaz.
          </p>
        </section>

      </div>
    </div>

  </main>
</div>

{% endblock %}
