{% extends "base.html" %}
{% block title %}Gestión de submódulo · Bundle{% endblock %}

{% block content %}
<div id="submodulePage"
     class="mx-auto max-w-none"
     data-oauth="{{ '1' if token else '0' }}"
     data-oauth-url="{{ url_for('cubicornio_auth.login', next=request.path) }}">

        <header class="flex items-start justify-between gap-4 flex-wrap">
          <div class="flex items-start gap-3">
            <div class="h-10 w-10 rounded-2xl bg-emerald-500/10 border border-emerald-400/40 flex items-center justify-center">
              <i data-lucide="blocks" class="w-5 h-5 text-emerald-200"></i>
            </div>
            <div>
              <h1 class="text-2xl md:text-3xl font-black">Gestión de submódulo</h1>
              <p class="mt-2 text-sm text-zinc-300 max-w-3xl">
                Este bundle trabaja con <b>1 submódulo</b>. Cuando selecciones uno,
                <b>todo lo demás se bloqueará</b> hasta que lo elimines.
              </p>

              <div class="mt-3 inline-flex items-center gap-2 rounded-full border border-slate-800 bg-slate-950 px-3 py-1 text-[11px] text-zinc-300">
                <i data-lucide="lock" class="w-4 h-4 text-zinc-300"></i>
                <span class="font-black text-zinc-200">Regla:</span>
                <span>1 submódulo por bundle (seleccionado a la vez)</span>
              </div>
            </div>
          </div>

          <a href="https://cubicornio.com/dev/my-modules"
             target="_blank" rel="noopener noreferrer"
             class="inline-flex items-center gap-2 rounded-full border border-emerald-400/60 bg-emerald-500 px-4 py-2 text-xs font-black text-slate-950 hover:bg-emerald-400 transition">
            <i data-lucide="square-arrow-out-up-right" class="w-4 h-4"></i>
            <span>Ver mis submódulos en Cubicornio</span>
          </a>
        </header>

        <div class="mt-5 flex flex-wrap items-center gap-2">
          {% if token %}
            <span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/10 border border-emerald-500/40 px-3 py-1 text-xs text-emerald-200">
              <i data-lucide="check-circle-2" class="w-4 h-4"></i> OAuth conectado
            </span>
          {% else %}
            <span class="inline-flex items-center gap-2 rounded-full bg-red-500/10 border border-red-500/40 px-3 py-1 text-xs text-red-200">
              <i data-lucide="x-circle" class="w-4 h-4"></i> Sin OAuth
            </span>
            <a href="{{ url_for('cubicornio_auth.login', next=request.path) }}"
               class="ml-1 inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 text-xs font-black hover:bg-emerald-400 transition">
              <i data-lucide="log-in" class="w-4 h-4"></i>
              <span>Conectar OAuth</span>
            </a>
          {% endif %}
        </div>

        <!-- PASOS -->
        <div class="mt-6 grid gap-4 md:grid-cols-3">
          <div class="rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
            <div class="text-[11px] uppercase tracking-wide text-zinc-400 font-black">1) Selecciona</div>
            <div class="mt-2 text-sm text-zinc-300">
              Elige el submódulo (domain/subdomain) con el repo correcto.
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
            <div class="text-[11px] uppercase tracking-wide text-zinc-400 font-black">2) El bundle crea</div>
            <div class="mt-2 text-sm text-zinc-300">
              Carpeta + scaffold en <code class="text-xs bg-slate-900 px-1 rounded border border-slate-800">modules/...</code>
              y configura <b>origin</b> (si hay repo).
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
            <div class="text-[11px] uppercase tracking-wide text-zinc-400 font-black">3) Si te equivocaste</div>
            <div class="mt-2 text-sm text-zinc-300">
              Borra el workspace local y recién podrás seleccionar otro.
            </div>
          </div>
        </div>

        <!-- SELECCIONADO -->
        <div id="selectedCard" class="mt-6 hidden rounded-2xl border border-emerald-500/30 bg-slate-950/70 p-4">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div class="min-w-0">
              <div class="text-sm font-black text-emerald-200">Submódulo seleccionado</div>
              <div id="selectedMeta" class="mt-1 text-xs text-zinc-300"></div>

              <!--  Git remote info (ROOT) -->
              <div class="mt-3 rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-xs text-zinc-200">
                <div class="flex items-start gap-2">
                  <div class="mt-0.5">
                    <i data-lucide="github" class="w-4 h-4 text-zinc-200"></i>
                  </div>
                  <div class="min-w-0">
                    <div class="font-black text-zinc-100">Git remoto configurado en el ROOT</div>
                    <div class="mt-1 text-zinc-300">
                      Para pushear al repo del submódulo usa:
                      <code class="ml-1 text-[11px] bg-slate-900 px-1.5 py-0.5 rounded border border-slate-800">
                        git push -u submodule &lt;branch&gt;
                      </code>
                    </div>
                    <div class="mt-1 text-[11px] text-zinc-400">
                      Tip: verifica con <code class="text-[11px] bg-slate-900 px-1 rounded border border-slate-800">git remote -v</code>
                      (debe aparecer <b>submodule</b>).
                    </div>
                  </div>
                </div>
              </div>

              <!-- Warning -->
              <div id="selectedWarning" class="mt-3 hidden rounded-xl border border-amber-500/30 bg-amber-500/10 px-3 py-2 text-xs text-amber-200">
                <div class="font-black">Warning del scaffold</div>
                <div id="selectedWarningText" class="mt-1 text-amber-100/90"></div>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <button id="deleteBtn"
                      class="inline-flex items-center gap-2 rounded-xl border border-rose-500/50 bg-rose-500/10 px-3 py-2 text-xs font-black text-rose-200 hover:bg-rose-500/15">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Eliminar workspace
              </button>
            </div>
          </div>
        </div>

        <!-- LISTA -->
        <div class="mt-6 rounded-2xl border border-slate-800 bg-slate-950/70 p-4">
          <div class="flex items-center justify-between gap-2 flex-wrap">
            <div>
              <div class="text-sm font-black">Tus submódulos</div>
              <div class="mt-1 text-xs text-zinc-400">
                Si ya hay un submódulo seleccionado, la lista queda bloqueada (solo podrás eliminar el seleccionado).
              </div>
            </div>

            <button id="reloadBtn"
                    class="inline-flex items-center gap-2 rounded-xl border border-slate-800 bg-slate-900 px-3 py-2 text-xs font-black text-zinc-100 hover:bg-slate-800">
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> Cargar lista
            </button>
          </div>

          <div id="emptyState" class="mt-4 rounded-xl border border-slate-800 bg-slate-950 p-4 text-sm text-zinc-400">
            Cargando submódulos...
          </div>

          <div class="mt-4 overflow-x-auto">
            <table id="subsTable" class="hidden min-w-full text-sm">
              <thead class="border-b border-slate-800 bg-slate-900 text-[11px] uppercase tracking-wide text-zinc-400">
                <tr>
                  <th class="text-left py-2 pr-4">Domain / Subdomain</th>
                  <th class="text-left py-2 pr-4">Submódulo</th>
                  <th class="text-left py-2 pr-4">Repo</th>
                  <th class="text-left py-2 pr-4">Acción</th>
                </tr>
              </thead>
              <tbody id="subsTbody"></tbody>
            </table>
          </div>
        </div>

</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- JS separado -->
<script src="{{ url_for('static', filename='js/submodules.js') }}"></script>
{% endblock %}
